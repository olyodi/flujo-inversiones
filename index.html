<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashflow Inversiones Argentina</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #3498db, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #7f8c8d;
        }

        .tab.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            transform: translateY(-2px);
        }

        .tab:hover:not(.active) {
            background: #d5dbdb;
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input, select {
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            font-weight: 600;
            text-align: left;
            font-size: 13px;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 13px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .amount {
            font-weight: 600;
            text-align: right;
        }

        .positive {
            color: #27ae60;
        }

        .negative {
            color: #e74c3c;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 10px;
            min-height: 80px;
            font-size: 12px;
        }

        .calendar-day.has-payment {
            border-color: #3498db;
            background: #ebf3fd;
        }

        .payment-item {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px 0;
            font-size: 10px;
        }

        .export-section {
            text-align: center;
            margin-top: 30px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .currency-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3498db;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>💰 Cashflow Inversiones Argentina</h1>
        
        <div class="currency-toggle">
            <span>ARS</span>
            <label class="switch">
                <input type="checkbox" id="currencyToggle">
                <span class="slider"></span>
            </label>
            <span>USD</span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'portfolio')">Cartera</button>
            <button class="tab" onclick="openTab(event, 'cashflow')">Cashflow</button>
            <button class="tab" onclick="openTab(event, 'calendar')">Calendario</button>
            <button class="tab" onclick="openTab(event, 'reports')">Reportes</button>
        </div>

        <div id="portfolio" class="tab-content active">
            <div class="form-section">
                <h3>Agregar Nueva Inversión</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Inversión</label>
                        <select id="tipoInversion">
                            <option value="ON">Obligación Negociable</option>
                            <option value="CEDEAR">CEDEAR</option>
                            <option value="FCI">Fondo Común de Inversión</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ticker/Nombre</label>
                        <input type="text" id="ticker" placeholder="Ej: GGAL, BBAR, etc.">
                    </div>
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" id="cantidad" placeholder="100">
                    </div>
                    <div class="form-group">
                        <label>Precio Compra</label>
                        <input type="number" id="precioCompra" step="0.01" placeholder="1000.50">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tasa/Dividendo Anual (%)</label>
                        <input type="number" id="tasa" step="0.01" placeholder="8.5">
                    </div>
                    <div class="form-group">
                        <label>Frecuencia de Pago</label>
                        <select id="frecuencia">
                            <option value="mensual">Mensual</option>
                            <option value="bimestral">Bimestral</option>
                            <option value="trimestral">Trimestral</option>
                            <option value="semestral">Semestral</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Próximo Pago</label>
                        <input type="date" id="proximoPago">
                    </div>
                    <div class="form-group">
                        <label>Moneda</label>
                        <select id="moneda">
                            <option value="ARS">ARS</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="agregarInversion()">Agregar Inversión</button>
            </div>

            <div class="table-container">
                <table id="portfolioTable">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Ticker</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Inversión Total</th>
                            <th>Tasa %</th>
                            <th>Frecuencia</th>
                            <th>Próximo Pago</th>
                            <th>Moneda</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="cashflow" class="tab-content">
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Ingresos Mensuales</h3>
                    <div class="value" id="ingresosMensuales">$0</div>
                    <small>Promedio estimado</small>
                </div>
                <div class="summary-card">
                    <h3>Ingresos Anuales</h3>
                    <div class="value" id="ingresosAnuales">$0</div>
                    <small>Proyección total</small>
                </div>
                <div class="summary-card">
                    <h3>Yield Promedio</h3>
                    <div class="value" id="yieldPromedio">0%</div>
                    <small>Rendimiento cartera</small>
                </div>
                <div class="summary-card">
                    <h3>Total Invertido</h3>
                    <div class="value" id="totalInvertido">$0</div>
                    <small>Capital total</small>
                </div>
            </div>

            <div class="table-container">
                <h3>Próximos Pagos (60 días)</h3>
                <table id="cashflowTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Ticker</th>
                            <th>Tipo</th>
                            <th>Monto Bruto</th>
                            <th>Impuestos (35%)</th>
                            <th>Monto Neto</th>
                            <th>Moneda</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="calendar" class="tab-content">
            <h3>Vista Calendario - Próximos Pagos</h3>
            <div id="calendarContainer">
                <div class="calendar-view" id="calendarView"></div>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <div class="form-section">
                <h3>Configuración de Reportes</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Período</label>
                        <select id="periodoReporte">
                            <option value="30">Últimos 30 días</option>
                            <option value="90">Últimos 90 días</option>
                            <option value="180">Últimos 6 meses</option>
                            <option value="365">Último año</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Reporte</label>
                        <select id="tipoReporte">
                            <option value="completo">Reporte Completo</option>
                            <option value="cashflow">Solo Cashflow</option>
                            <option value="rendimientos">Solo Rendimientos</option>
                        </select>
                    </div>
                </div>
                <div class="export-section">
                    <button class="btn btn-success" onclick="exportarExcel()">📊 Exportar a Excel</button>
                    <button class="btn btn-primary" onclick="exportarCSV()">📄 Exportar a CSV</button>
                </div>
            </div>

            <div class="table-container">
                <h3>Resumen por Instrumento</h3>
                <table id="summaryTable">
                    <thead>
                        <tr>
                            <th>Instrumento</th>
                            <th>Tipo</th>
                            <th>Inversión</th>
                            <th>Ingresos YTD</th>
                            <th>Yield YTD</th>
                            <th>Próximo Pago</th>
                            <th>Monto Próximo</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let portfolio = JSON.parse(localStorage.getItem('portfolio')) || [];
        let cashflowData = JSON.parse(localStorage.getItem('cashflowData')) || [];
        let usdRate = 1200; // Tipo de cambio aproximado
        let showUSD = false;

        function openTab(evt, tabName) {
            var i, tabcontent, tabs;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tabs = document.getElementsByClassName("tab");
            for (i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            if (tabName === 'cashflow') {
                updateCashflowTable();
                updateSummaryCards();
            } else if (tabName === 'calendar') {
                generateCalendar();
            } else if (tabName === 'reports') {
                updateSummaryTable();
            }
        }

        function agregarInversion() {
            const tipo = document.getElementById('tipoInversion').value;
            const ticker = document.getElementById('ticker').value;
            const cantidad = parseFloat(document.getElementById('cantidad').value);
            const precio = parseFloat(document.getElementById('precioCompra').value);
            const tasa = parseFloat(document.getElementById('tasa').value);
            const frecuencia = document.getElementById('frecuencia').value;
            const proximoPago = document.getElementById('proximoPago').value;
            const moneda = document.getElementById('moneda').value;

            if (!ticker || !cantidad || !precio || !tasa || !proximoPago) {
                alert('Por favor complete todos los campos');
                return;
            }

            const inversion = {
                id: Date.now(),
                tipo,
                ticker: ticker.toUpperCase(),
                cantidad,
                precio,
                tasa,
                frecuencia,
                proximoPago,
                moneda,
                inversionTotal: cantidad * precio
            };

            portfolio.push(inversion);
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            
            updatePortfolioTable();
            clearForm();
            generateCashflowProjections();
        }

        function clearForm() {
            document.getElementById('ticker').value = '';
            document.getElementById('cantidad').value = '';
            document.getElementById('precioCompra').value = '';
            document.getElementById('tasa').value = '';
            document.getElementById('proximoPago').value = '';
        }

        function updatePortfolioTable() {
            const tbody = document.querySelector('#portfolioTable tbody');
            tbody.innerHTML = '';

            portfolio.forEach(inv => {
                const row = tbody.insertRow();
                const inversionDisplay = formatCurrency(inv.inversionTotal, inv.moneda);
                
                row.innerHTML = `
                    <td>${inv.tipo}</td>
                    <td><strong>${inv.ticker}</strong></td>
                    <td>${inv.cantidad.toLocaleString()}</td>
                    <td>${formatCurrency(inv.precio, inv.moneda)}</td>
                    <td class="amount">${inversionDisplay}</td>
                    <td>${inv.tasa}%</td>
                    <td>${inv.frecuencia}</td>
                    <td>${formatDate(inv.proximoPago)}</td>
                    <td>${inv.moneda}</td>
                    <td>
                        <button class="btn btn-danger" onclick="eliminarInversion(${inv.id})" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                    </td>
                `;
            });
        }

        function eliminarInversion(id) {
            if (confirm('¿Está seguro de eliminar esta inversión?')) {
                portfolio = portfolio.filter(inv => inv.id !== id);
                localStorage.setItem('portfolio', JSON.stringify(portfolio));
                updatePortfolioTable();
                generateCashflowProjections();
            }
        }

        function generateCashflowProjections() {
            cashflowData = [];
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(today.getDate() + 365); // Proyectar 1 año

            portfolio.forEach(inv => {
                let currentDate = new Date(inv.proximoPago);
                const frecuenciaDias = getFrecuenciaDias(inv.frecuencia);
                const montoAnual = (inv.inversionTotal * inv.tasa) / 100;
                const montoPorPago = montoAnual / getFrecuenciaAnual(inv.frecuencia);

                while (currentDate <= endDate) {
                    if (currentDate >= today) {
                        const montoBruto = montoPorPago;
                        const impuestos = montoBruto * 0.35; // 35% impuestos
                        const montoNeto = montoBruto - impuestos;

                        cashflowData.push({
                            fecha: new Date(currentDate),
                            ticker: inv.ticker,
                            tipo: inv.tipo,
                            montoBruto,
                            impuestos,
                            montoNeto,
                            moneda: inv.moneda
                        });
                    }
                    currentDate.setDate(currentDate.getDate() + frecuenciaDias);
                }
            });

            cashflowData.sort((a, b) => a.fecha - b.fecha);
            localStorage.setItem('cashflowData', JSON.stringify(cashflowData, dateReplacer));
        }

        function dateReplacer(key, value) {
            if (value instanceof Date) {
                return value.toISOString();
            }
            return value;
        }

        function getFrecuenciaDias(frecuencia) {
            const dias = {
                'mensual': 30,
                'bimestral': 60,
                'trimestral': 90,
                'semestral': 180,
                'anual': 365
            };
            return dias[frecuencia] || 30;
        }

        function getFrecuenciaAnual(frecuencia) {
            const veces = {
                'mensual': 12,
                'bimestral': 6,
                'trimestral': 4,
                'semestral': 2,
                'anual': 1
            };
            return veces[frecuencia] || 12;
        }

        function updateCashflowTable() {
            const tbody = document.querySelector('#cashflowTable tbody');
            tbody.innerHTML = '';

            const today = new Date();
            const futureDate = new Date();
            futureDate.setDate(today.getDate() + 60);

            const proximosPagos = cashflowData
                .map(item => ({...item, fecha: new Date(item.fecha)}))
                .filter(item => item.fecha >= today && item.fecha <= futureDate)
                .slice(0, 20);

            proximosPagos.forEach(pago => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(pago.fecha)}</td>
                    <td><strong>${pago.ticker}</strong></td>
                    <td>${pago.tipo}</td>
                    <td class="amount positive">${formatCurrency(pago.montoBruto, pago.moneda)}</td>
                    <td class="amount negative">-${formatCurrency(pago.impuestos, pago.moneda)}</td>
                    <td class="amount positive"><strong>${formatCurrency(pago.montoNeto, pago.moneda)}</strong></td>
                    <td>${pago.moneda}</td>
                `;
            });
        }

        function updateSummaryCards() {
            const today = new Date();
            const añoActual = today.getFullYear();
            
            // Calcular ingresos mensuales promedio
            const ingresosMensuales = cashflowData
                .filter(item => {
                    const fechaPago = new Date(item.fecha);
                    return fechaPago.getFullYear() === añoActual;
                })
                .reduce((sum, item) => sum + (item.montoNeto || 0), 0) / 12;

            // Calcular ingresos anuales
            const ingresosAnuales = cashflowData
                .filter(item => {
                    const fechaPago = new Date(item.fecha);
                    return fechaPago.getFullYear() === añoActual;
                })
                .reduce((sum, item) => sum + (item.montoNeto || 0), 0);

            // Calcular total invertido y yield promedio
            const totalInvertidoARS = portfolio.reduce((sum, inv) => {
                return sum + (inv.moneda === 'ARS' ? inv.inversionTotal : inv.inversionTotal * usdRate);
            }, 0);

            const yieldPromedio = portfolio.length > 0 
                ? portfolio.reduce((sum, inv) => sum + inv.tasa, 0) / portfolio.length 
                : 0;

            document.getElementById('ingresosMensuales').textContent = formatCurrency(ingresosMensuales, 'ARS');
            document.getElementById('ingresosAnuales').textContent = formatCurrency(ingresosAnuales, 'ARS');
            document.getElementById('yieldPromedio').textContent = yieldPromedio.toFixed(2) + '%';
            document.getElementById('totalInvertido').textContent = formatCurrency(totalInvertidoARS, 'ARS');
        }

        function generateCalendar() {
            const calendarView = document.getElementById('calendarView');
            calendarView.innerHTML = '';

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();

            // Generar días del calendario
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                const currentDate = new Date(currentYear, currentMonth, day);
                const pagosDelDia = cashflowData.filter(item => {
                    const fechaPago = new Date(item.fecha);
                    return fechaPago.toDateString() === currentDate.toDateString();
                });

                if (pagosDelDia.length > 0) {
                    dayDiv.classList.add('has-payment');
                }

                dayDiv.innerHTML = `
                    <strong>${day}</strong>
                    ${pagosDelDia.map(pago => 
                        `<div class="payment-item">${pago.ticker}: ${formatCurrency(pago.montoNeto, pago.moneda)}</div>`
                    ).join('')}
                `;

                calendarView.appendChild(dayDiv);
            }
        }

        function updateSummaryTable() {
            const tbody = document.querySelector('#summaryTable tbody');
            tbody.innerHTML = '';

            const today = new Date();
            const yearStart = new Date(today.getFullYear(), 0, 1);

            portfolio.forEach(inv => {
                const ingresosYTD = cashflowData
                    .filter(item => {
                        const fechaPago = new Date(item.fecha);
                        return item.ticker === inv.ticker && 
                               fechaPago >= yearStart && 
                               fechaPago <= today;
                    })
                    .reduce((sum, item) => sum + (item.montoNeto || 0), 0);

                const yieldYTD = inv.inversionTotal > 0 ? (ingresosYTD / inv.inversionTotal) * 100 : 0;

                const proximoPago = cashflowData
                    .filter(item => item.ticker === inv.ticker && new Date(item.fecha) > today)
                    .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))[0];

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${inv.ticker}</strong></td>
                    <td>${inv.tipo}</td>
                    <td class="amount">${formatCurrency(inv.inversionTotal, inv.moneda)}</td>
                    <td class="amount positive">${formatCurrency(ingresosYTD, inv.moneda)}</td>
                    <td class="amount">${yieldYTD.toFixed(2)}%</td>
                    <td>${proximoPago ? formatDate(proximoPago.fecha) : 'N/A'}</td>
                    <td class="amount positive">${proximoPago ? formatCurrency(proximoPago.montoNeto, proximoPago.moneda) : 'N/A'}</td>
                `;
            });
        }

        function formatCurrency(amount, currency) {
            if (showUSD && currency === 'ARS') {
                amount = amount / usdRate;
                currency = 'USD';
            } else if (!showUSD && currency === 'USD') {
                amount = amount * usdRate;
                currency = 'ARS';
            }

            const symbol = currency === 'USD' ? 'US : ';
            return symbol + amount.toLocaleString('es-AR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatDate(date) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            return date.toLocaleDateString('es-AR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function exportarExcel() {
            const data = [];
            data.push(['Reporte de Cashflow - Inversiones Argentina']);
            data.push(['Generado el:', new Date().toLocaleDateString('es-AR')]);
            data.push([]);
            
            // Resumen de cartera
            data.push(['RESUMEN DE CARTERA']);
            data.push(['Instrumento', 'Tipo', 'Cantidad', 'Precio', 'Inversión Total', 'Tasa %', 'Frecuencia', 'Moneda']);
            
            portfolio.forEach(inv => {
                data.push([
                    inv.ticker,
                    inv.tipo,
                    inv.cantidad,
                    inv.precio,
                    inv.inversionTotal,
                    inv.tasa,
                    inv.frecuencia,
                    inv.moneda
                ]);
            });

            data.push([]);
            data.push(['PROYECCIÓN DE PAGOS']);
            data.push(['Fecha', 'Ticker', 'Tipo', 'Monto Bruto', 'Impuestos', 'Monto Neto', 'Moneda']);

            const today = new Date();
            const futurePayments = cashflowData
                .filter(item => new Date(item.fecha) >= today)
                .slice(0, 50);

            futurePayments.forEach(pago => {
                data.push([
                    formatDate(pago.fecha),
                    pago.ticker,
                    pago.tipo,
                    pago.montoBruto,
                    pago.impuestos,
                    pago.montoNeto,
                    pago.moneda
                ]);
            });

            downloadCSV(data, 'cashflow_inversiones.csv');
        }

        function exportarCSV() {
            const data = [
                ['Fecha', 'Ticker', 'Tipo', 'Monto Bruto', 'Impuestos', 'Monto Neto', 'Moneda']
            ];

            const today = new Date();
            const futurePayments = cashflowData
                .filter(item => new Date(item.fecha) >= today)
                .slice(0, 100);

            futurePayments.forEach(pago => {
                data.push([
                    formatDate(pago.fecha),
                    pago.ticker,
                    pago.tipo,
                    pago.montoBruto.toFixed(2),
                    pago.impuestos.toFixed(2),
                    pago.montoNeto.toFixed(2),
                    pago.moneda
                ]);
            });

            downloadCSV(data, 'cashflow_proyeccion.csv');
        }

        function downloadCSV(data, filename) {
            const csvContent = data.map(row => 
                row.map(cell => {
                    if (typeof cell === 'string' && cell.includes(',')) {
                        return `"${cell}"`;
                    }
                    return cell;
                }).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Event Listeners
        document.getElementById('currencyToggle').addEventListener('change', function(e) {
            showUSD = e.target.checked;
            updatePortfolioTable();
            updateCashflowTable();
            updateSummaryCards();
            updateSummaryTable();
        });

        // Autocompletar tickers argentinos comunes
        document.getElementById('ticker').addEventListener('input', function(e) {
            const value = e.target.value.toUpperCase();
            const commonTickers = [
                'GGAL', 'BBAR', 'SUPV', 'YPF', 'PAM', 'TXAR', 'ALUA', 'MIRG',
                'CEPU', 'VALO', 'LOMA', 'BYMA', 'HAVA', 'PAMP', 'AGRO', 'BOLT',
                'CRES', 'EDN', 'EDENOR', 'DGCU2', 'DGCE', 'LONG', 'COME'
            ];
            
            // Simple autosuggestion (could be enhanced with a dropdown)
            if (value.length >= 2) {
                const suggestions = commonTickers.filter(ticker => 
                    ticker.startsWith(value)
                );
                // Here you could implement a suggestion dropdown
            }
        });

        // Set default date to next month
        document.addEventListener('DOMContentLoaded', function() {
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            nextMonth.setDate(1);
            document.getElementById('proximoPago').value = nextMonth.toISOString().split('T')[0];
            
            // Load saved data
            updatePortfolioTable();
            generateCashflowProjections();
            
            // Load cashflow data from localStorage with date parsing
            const savedCashflow = localStorage.getItem('cashflowData');
            if (savedCashflow) {
                try {
                    cashflowData = JSON.parse(savedCashflow).map(item => ({
                        ...item,
                        fecha: new Date(item.fecha)
                    }));
                } catch (e) {
                    console.warn('Error loading cashflow data:', e);
                    generateCashflowProjections();
                }
            }
        });

        // Add sample data function (for testing)
        function addSampleData() {
            const sampleInvestments = [
                {
                    id: Date.now() + 1,
                    tipo: 'CEDEAR',
                    ticker: 'GGAL',
                    cantidad: 100,
                    precio: 5400,
                    tasa: 8.5,
                    frecuencia: 'trimestral',
                    proximoPago: '2025-09-15',
                    moneda: 'ARS',
                    inversionTotal: 540000
                },
                {
                    id: Date.now() + 2,
                    tipo: 'ON',
                    ticker: 'BBAR',
                    cantidad: 50,
                    precio: 1200,
                    tasa: 12.0,
                    frecuencia: 'semestral',
                    proximoPago: '2025-10-01',
                    moneda: 'ARS',
                    inversionTotal: 60000
                }
            ];

            portfolio = [...portfolio, ...sampleInvestments];
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            updatePortfolioTable();
            generateCashflowProjections();
        }
    </script>
</body>
</html>